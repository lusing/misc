# 2023å¹´çš„æ·±åº¦å­¦ä¹ å…¥é—¨æŒ‡å—(13) - å†™åç«¯

æˆ‘ä»¬å‰é¢å­¦ä¹ äº†ç”¨pythonåœ¨æœ¬æœºä¸Šå†™å‰ç«¯ï¼Œä¹Ÿå­¦ä¹ äº†ä½¿ç”¨HTMLåœ¨æœ¬æœºå†™å‰ç«¯ã€‚åŒç†ï¼Œæˆ‘ä»¬å¯ä»¥å†™Windowsåº”ç”¨ï¼Œmacåº”ç”¨ï¼ŒiOSåº”ç”¨ï¼ŒAndroidåº”ç”¨ç­‰ç­‰ä»¥é€‚åˆå„ç§ç»ˆç«¯ã€‚å…¶å®ï¼Œæœ€é€šç”¨çš„ç»ˆç«¯å°±æ˜¯Webå‰ç«¯ã€‚

ä¸ºäº†ä½¿ç”¨Webå‰ç«¯ï¼Œæˆ‘ä»¬éœ€è¦å†™åç«¯ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡ç«¯ä»£ç ã€‚

å†™åç«¯å¯ä»¥æœ‰å“ªäº›å¥½å¤„ï¼Ÿ
é¦–å…ˆï¼Œæœ‰äº†åç«¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†æ•°æ®å­˜å‚¨åˆ°æ•°æ®åº“é‡Œè¿›è¡Œå­˜å‚¨å’Œè¿›ä¸€æ­¥çš„åˆ†æã€‚
å…¶æ¬¡ï¼Œæœ‰äº†åç«¯ï¼Œæˆ‘ä»¬å¯ä»¥æ¥å¤šä¸ªAPIæä¾›æ–¹ï¼Œæä¾›1+1>2çš„æ•ˆæœã€‚
ç¬¬ä¸‰ï¼Œåç«¯è¿è¡Œåœ¨æœåŠ¡å™¨ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æœåŠ¡å™¨çš„è®¡ç®—èµ„æºï¼Œè€Œä¸æ˜¯è‡ªå·±çš„ç”µè„‘çš„è®¡ç®—èµ„æºï¼Œæ›´åŠ ç¨³å®šã€‚
æœ€åï¼Œæœ‰äº†åç«¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥æä¾›æœåŠ¡ç»™å…¶ä»–å°ä¼™ä¼´ä½¿ç”¨äº†ã€‚

## åŸºäºå¼€æºé¡¹ç›®ä¿®æ”¹è‡ªå·±çš„åç«¯

chatgptçš„ç”Ÿæ€å¦‚æ­¤ä¸°å¯Œï¼Œæˆ‘ä»¬æœ‰å¤§é‡çš„å¼€æºé¡¹ç›®å¯ä»¥å‚è€ƒã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™äº›é¡¹ç›®ï¼Œå½“ç„¶å¤šæ•°æƒ…å†µè‚¯å®šæ˜¯è¦è¿›è¡Œä¸€äº›è‡ªå·±çš„ä¿®æ”¹ï¼Œè¦ä¸ç„¶ç›´æ¥ç”¨ç¬¬ä¸‰æ–¹çš„ç°æˆäº§å“å°±å¥½äº†ã€‚é€šè¿‡ä¿®æ”¹è¿™äº›å¼€æºé¡¹ç›®ï¼Œå¯ä»¥å¤§å¤§åŠ é€Ÿä¸Šçº¿æ—¶é—´ï¼Œä¹Ÿæ–¹ä¾¿æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚

æˆ‘ä»¬è¿™é‡Œé€‰ç”¨chatgpt-demoé¡¹ç›®æ¥ä½œä¸ºè®²è§£çš„ä¾‹å­ï¼Œå®ƒçš„åœ°å€åœ¨ï¼šhttps://github.com/anse-app/chatgpt-demoã€‚

### è¿è¡Œchatgpt-demo

æˆ‘ä¸ªäººé€‰å–å®ƒä½œä¸ºä¾‹å­çš„åŸå› æ˜¯å› ä¸ºå®ƒæ˜¯åŸºäºastroå†™çš„ï¼Œä»£ç çœ‹èµ·æ¥æ¯”è¾ƒæ¸…çˆ½ã€‚Astroæ˜¯åŸºäºNode.jsçš„ï¼Œè·Ÿå‰ç«¯ä¸€æ ·éƒ½æ˜¯jsï¼Œå¯¹äºæ–°åŒå­¦å…¥é—¨çš„è¯æ¯”è¾ƒå‹å¥½ã€‚

æˆ‘ä»¬é¦–å…ˆcloneè¿™ä¸ªé¡¹ç›®ï¼š

```
git clone https://github.com/anse-app/chatgpt-demo
```

ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬å®‰è£…Node.jsï¼Œå¯ä»¥ç›´æ¥ä»Nodejs.orgä¸‹è½½å®‰è£…åŒ…ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨nvmæ¥å®‰è£…ã€‚nvmè¯·å‚ç…§ï¼šhttps://github.com/nvm-sh/nvmã€‚

ç¬¬ä¸‰æ­¥ï¼Œæˆ‘ä»¬å®‰è£…ä¾èµ–ï¼š

```
npm install pnpm -g
pnpm install
```

pnpmçš„é€Ÿåº¦è¦æ¯”npmå¿«å¾ˆå¤šï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä½¿ç”¨pnpmã€‚

ç¬¬å››æ­¥ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ã€‚

æ‰¾åˆ°ç›®å½•ä¸‹çš„.env.exampleæ–‡ä»¶ï¼Œå°†å®ƒå¤åˆ¶ä¸€ä»½å¹¶å‘½åä¸º.envï¼Œç„¶åä¿®æ”¹é‡Œé¢çš„é…ç½®ã€‚
æœ€ä¸»è¦ä¿®æ”¹çš„æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œå…¶ä¸­åªæœ‰ç¬¬ä¸€ä¸ªæ˜¯å¼ºåˆ¶è¦æ±‚çš„ï¼š
- ç¬¬ä¸€ä¸ªæ˜¯OPENAI_API_KEYï¼Œè¿™ä¸ªæ˜¯æˆ‘ä»¬çš„OpenAI API Key
- ç¬¬äºŒä¸ªæ˜¯HTTPS_PROXYï¼Œå¦‚æœä½ éœ€è¦ä½¿ç”¨ä»£ç†çš„è¯ï¼Œå¯ä»¥åœ¨è¿™é‡Œè®¾ç½®ï¼Œå¦åˆ™ä¸ç”¨è®¾ç½®
- ç¬¬ä¸‰ä¸ªæ˜¯SITE_PASSWORDï¼Œè¿™ä¸ªæ˜¯æˆ‘ä»¬çš„å¯†ç ï¼Œå¦‚æœä¸è®¾ç½®çš„è¯ï¼Œå°±æ˜¯å…¬å¼€çš„ï¼Œä»»ä½•äººéƒ½å¯ä»¥è®¿é—®

```
# Your API Key for OpenAI
OPENAI_API_KEY=ä½ çš„API Key
# Provide proxy for OpenAI API. e.g. http://127.0.0.1:7890
HTTPS_PROXY=
# Custom base url for OpenAI API. default: https://api.openai.com
OPENAI_API_BASE_URL=
# Inject analytics or other scripts before </head> of the page
HEAD_SCRIPTS=
# Secret string for the project. Use for generating signatures for API calls
PUBLIC_SECRET_KEY=
# Set password for site, support multiple password separated by comma. If not set, site will be public
SITE_PASSWORD=ä½ çš„å¯†ç 
# ID of the model to use. https://platform.openai.com/docs/api-reference/models/list
OPENAI_API_MODEL=gpt-4
```

ç¬¬äº”æ­¥ï¼Œè¿è¡Œï¼š

```
pnpm start --host
```

æ³¨æ„ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†--hostå‚æ•°ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨å¤–ç½‘è®¿é—®è¿™ä¸ªåº”ç”¨äº†ã€‚

è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š
```
> chatgpt-api-demo@0.0.1 start /root/code/chatgpt-demo
> astro dev "--host"

  ğŸš€  astro  v2.1.3 started in 355ms
  
  â”ƒ Local    http://localhost:3000/
  â”ƒ Network  http://192.168.0.189:3000/
```

ç¬¬å…­æ­¥ï¼Œè®¿é—®ã€‚

æˆ‘ä»¬å°±å¯ä»¥è®¿é—®æˆ‘ä»¬çš„gptåº”ç”¨äº†ã€‚å¦‚æœä½ è®¾ç½®äº†å¯†ç ï¼Œé‚£ä¹ˆå°±éœ€è¦è¾“å…¥å¯†ç æ‰èƒ½è®¿é—®ã€‚
åœ°å€å‚ç…§ä½ è¿è¡Œpnpm start --hostçš„è¾“å‡ºç»“æœã€‚æ¯”å¦‚æˆ‘çš„å°±æ˜¯ï¼šhttp://192.168.0.189:3000/

ä¸‹é¢æ˜¯æˆ‘çš„è¿è¡Œç»“æœï¼Œæˆ‘ä¿®æ”¹äº†ä¸€ç‚¹ï¼Œè·Ÿä½ çš„å¯èƒ½ä¸ä¸€æ ·ï¼š

ä¸‹é¢çš„å®˜æ–¹çš„ç»“æœï¼š

![](https://user-images.githubusercontent.com/46418596/225495192-220a0b91-75a8-41f8-9859-a3f9e6c7acec.png)

### å®šåˆ¶åŒ–è‡ªå·±çš„chatgpt-demo

ä¸‹é¢æˆ‘ä»¬å°±å¯ä»¥è¿›è¡Œè‡ªå·±çš„å®šåˆ¶äº†ã€‚é€‰è¿™ä¸ªAstroå·¥ç¨‹çš„åŸå› ä¸ºå°±æ˜¯ä¿®æ”¹èµ·æ¥å¾ˆæ–¹ä¾¿ï¼Œæ¯”å¦‚é¦–é¡µçš„å¤´éƒ¨çš„ä»£ç ï¼Œå¤§å®¶å¯ä»¥çœ‹åˆ°å°±æ˜¯éå¸¸ç®€å•çš„å‡ ä¸ªæ ‡é¢˜å­—ç¬¦ä¸²ï¼Œå¤§å®¶æƒ³æ”¹æˆä»€ä¹ˆå°±æ”¹æˆä»€ä¹ˆã€‚

```xml
---
import { model } from '../utils/openAI'
import Logo from './Logo.astro'
import Themetoggle from './Themetoggle.astro'
---

<header>
  <div class="fb items-center">
    <Logo />
    <Themetoggle />
  </div>
  <div class="fi mt-2">
    <span class="gpt-title">æ—­ä¼¦GPT</span>
    <span class="gpt-subtitle">1.0</span>
  </div>
  <p mt-1 op-60>Powered by OpenAI API ({model}).</p>
</header>
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œçš„ä»£ç æ˜¯astroçš„ä»£ç ï¼Œå®ƒçš„è¯­æ³•è·ŸHTMLéå¸¸ç›¸ä¼¼ï¼Œä½†æ˜¯å®ƒå¯ä»¥ç›´æ¥ä½¿ç”¨jsï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œå†™jsä»£ç ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸»é¡µçš„å†…å®¹ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯header, footeråŠ ä¸Šä¸€æ®µæ£€æŸ¥å¯†ç çš„ä»£ç ï¼š

```xml
---
import Layout from '../layouts/Layout.astro'
import Header from '../components/Header.astro'
import Footer from '../components/Footer.astro'
import Generator from '../components/Generator'
import '../message.css'
import 'katex/dist/katex.min.css'
import 'highlight.js/styles/atom-one-dark.css'
---

<Layout title="Xulun GPT">
  <main >
    <Header />
    <Generator client:load />
    <Footer />
  </main>
</Layout>

<script>
async function checkCurrentAuth() {
  const password = localStorage.getItem('pass')
  const response = await fetch('/api/auth', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      pass: password,
    }),
  })
  const responseJson = await response.json()
  if (responseJson.code !== 0)
    window.location.href = '/password'
}
checkCurrentAuth()
</script>
```

è¿è¡Œä¸€ä¸‹ä¿®æ”¹çš„ï¼Œæˆ‘çš„å°±å˜æˆäº†è¿™æ ·ï¼š
![](https://xulun-games.oss-cn-beijing.aliyuncs.com/%E6%88%AA%E5%B1%8F2023-05-13%2000.28.41.png?Expires=1683911066&OSSAccessKeyId=TMP.3KjoFQX73x2Xr8f2nk5RNnLZ3a3dzWemzPweHcLpJX55aQLAyXdNZLLhP6MxcGMUVUkTYHoSa8hgWCNYwtDQViYnWoCovh&Signature=EW6stiJCZW36YPJMTcMs%2FRMrvLs%3D)

æœ€åæˆ‘ä»¬å†çœ‹ä¸€ä¸‹chatgpt-demoé‡Œé¢æ˜¯å¦‚ä½•è°ƒç”¨openaiçš„ï¼š

```js
export const model = import.meta.env.OPENAI_API_MODEL || 'gpt-3.5-turbo'

export const generatePayload = (apiKey: string, messages: ChatMessage[]): RequestInit & { dispatcher?: any } => ({
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${apiKey}`,
  },
  method: 'POST',
  body: JSON.stringify({
    model,
    messages,
    temperature: 0.6,
    stream: true,
  }),
})
```

æˆ‘ä»¬çœ‹åˆ°äº†stream: trueï¼Œè¿™æ˜¯ä»¥æµå¼çš„æ–¹å¼æ¥è®¿é—®openaiçš„API. 

æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹æ¥æµæ˜¯å¦‚ä½•å¤„ç†çš„ï¼š

```javascript
  const stream = new ReadableStream({
    async start(controller) {
      const streamParser = (event: ParsedEvent | ReconnectInterval) => {
        if (event.type === 'event') {
          const data = event.data
          if (data === '[DONE]') {
            controller.close()
            return
          }
          try {
            const json = JSON.parse(data)
            const text = json.choices[0].delta?.content || ''
            const queue = encoder.encode(text)
            controller.enqueue(queue)
          } catch (e) {
            controller.error(e)
          }
        }
      }

      const parser = createParser(streamParser)
      for await (const chunk of rawResponse.body as any)
        parser.feed(decoder.decode(chunk))
    },
  })
```

è¿™æ®µä»£ç åˆ›å»ºäº†ä¸€ä¸ªReadableStreamå¯¹è±¡ï¼Œå®ƒæ˜¯ç”¨äºå¤„ç†æµå¼æ•°æ®çš„Web APIã€‚

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œåªä½¿ç”¨äº†startæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨æµè¢«æ„é€ æˆ–è€…éœ€è¦æä¾›æ•°æ®æ—¶ä¼šè¢«è°ƒç”¨ã€‚startæ–¹æ³•æ¥æ”¶ä¸€ä¸ªcontrollerå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªReadableStreamDefaultControllerå¯¹è±¡ï¼Œå®ƒæä¾›äº†enqueueã€closeå’Œerrorç­‰æ–¹æ³•ï¼Œå¯ä»¥ç”¨æ¥æ§åˆ¶æµçš„çŠ¶æ€ã€‚

è§£æäº‹ä»¶æµçš„å·¥ä½œæ˜¯é€šè¿‡createParseræ–¹æ³•åˆ›å»ºçš„parserå¯¹è±¡æ¥å®Œæˆçš„ã€‚è¿™ä¸ªparserå¯¹è±¡ä¼šå¯¹æœåŠ¡å™¨å‘é€çš„æ¯ä¸€å—æ•°æ®ï¼ˆchunkï¼‰è¿›è¡Œè§£æï¼Œç„¶åè°ƒç”¨streamParserå‡½æ•°å¤„ç†è§£æåçš„äº‹ä»¶ã€‚

streamParserå‡½æ•°ä¼šæ£€æŸ¥äº‹ä»¶çš„ç±»å‹ï¼Œå¦‚æœäº‹ä»¶ç±»å‹ä¸ºeventï¼Œå®ƒå°±ä¼šæå–å‡ºäº‹ä»¶ä¸­çš„æ•°æ®ï¼Œç„¶åå°è¯•å°†æ•°æ®è§£æä¸ºJSONæ ¼å¼ï¼Œå¹¶æå–å‡ºå…¶ä¸­çš„æ–‡æœ¬ä¿¡æ¯ã€‚å¦‚æœæ•°æ®æ˜¯[DONE]ï¼Œå®ƒå°±ä¼šå…³é—­æµã€‚å¦‚æœåœ¨è§£ææˆ–æå–è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œå®ƒå°±ä¼šè°ƒç”¨controller.erroræ–¹æ³•å¹¶ä¼ å…¥é”™è¯¯å¯¹è±¡ï¼Œä½¿å¾—æµè¿›å…¥é”™è¯¯çŠ¶æ€ã€‚

åŸºæœ¬ä¸Šæˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºï¼Œå¦‚æœä¸€ä¸ªchunkæ˜¯[DONE]ï¼Œé‚£ä¹ˆå°±å…³é—­æµï¼Œå¦åˆ™å°±æŠŠchunkè§£ææˆjsonï¼Œç„¶åæŠŠjsoné‡Œé¢çš„delta.contentå­—æ®µçš„å†…å®¹æ”¾å…¥åˆ°æµé‡Œé¢ã€‚

OKã€‚ç°åœ¨éœ€è¦ä»€ä¹ˆåŠŸèƒ½ï¼Œä½ å°±å¯ä»¥åœ¨è¿™ä¸ªå·¥ç¨‹çš„åŸºç¡€ä¸Šä¿®æ”¹äº†ã€‚
å¦‚æœé‡åˆ°æ— æ³•è¿æ¥ä¹‹ç±»çš„é—®é¢˜ï¼Œå¯ä»¥å‚è€ƒè¿™ä¸ªï¼šhttps://github.com/anse-app/chatgpt-demo/discussions/270

## è‡ªå·±å†™åç«¯

å…‰ç”¨åˆ«äººçš„ä¸œè¥¿ï¼Œå¯èƒ½å¯¹äºç»†èŠ‚å°±ç¼ºå¤±äº†ä¸€äº›äº†è§£ã€‚è€Œä¸”ï¼Œä¸»æµçš„åç«¯è¿˜æ˜¯åŸºäºSpring Bootæ¡†æ¶ï¼Œä½¿ç”¨Javaæˆ–è€…æ˜¯Kotlinæ¥å†™çš„ã€‚

ç¼–è¯‘Spring Bootå·¥ç¨‹çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦mavenæˆ–è€…æ˜¯gradleè¿™æ ·çš„æ„å»ºå·¥å…·ï¼Œå®ƒæœ‰ä¸­å¿ƒä»“åº“ï¼Œå¯ä»¥è‡ªåŠ¨ä¸‹è½½ä¾èµ–ã€‚å†™Spring Bootçš„è¯ï¼Œæˆ‘ä»¬æœ€å¥½æœ‰ä¸ªè¶æ‰‹çš„IDEï¼Œæ¯”å¦‚IntelliJ IDEAæˆ–è€…æ˜¯Visual Studio Codeã€‚

![](https://xulun-games.oss-cn-beijing.aliyuncs.com/ij.png?Expires=1683911675&OSSAccessKeyId=TMP.3KjoFQX73x2Xr8f2nk5RNnLZ3a3dzWemzPweHcLpJX55aQLAyXdNZLLhP6MxcGMUVUkTYHoSa8hgWCNYwtDQViYnWoCovh&Signature=KBKMuF1HfAtAk5toMYfS7thavdM%3D)

### å†™ä¸»ç±»

æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒJavaåº”ç”¨éœ€è¦ä¸€ä¸ªä¸»ç±»ï¼Œè¿™ä¸ªä¸»ç±»éœ€è¦æœ‰mainæ–¹æ³•ï¼Œè¿™ä¸ªmainæ–¹æ³•æ˜¯ç¨‹åºçš„å…¥å£ã€‚

åœ¨Spring Bootåº”ç”¨é‡Œé¢ï¼Œè¿™ä¸ªå·¥ä½œäº¤ç»™SpringApplicationç±»æ¥å®Œæˆã€‚æˆ‘ä»¬çš„mainæ–¹æ³•å¦‚ä¸‹ï¼š

```kotlin
package cn.lusing.chat.chat

import org.springframework.boot.autoconfigure.SpringBootApplication
import org.springframework.boot.runApplication

@SpringBootApplication
class ChatApplication

fun main(args: Array<String>) {
	runApplication<ChatApplication>(*args)
}
```

ä¸ºäº†èƒ½è®©è¿™ä¸ªåº”ç”¨è¿è¡Œèµ·æ¥ï¼Œæˆ‘ä»¬éœ€è¦å†™ä¸€ä¸ªpom.xml:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>3.0.6</version>
		<relativePath/> <!-- lookup parent from repository -->
	</parent>
	<groupId>cn.lusing.chat</groupId>
	<artifactId>chat</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<name>chat</name>
	<description>Demo project for Spring Boot</description>
	<properties>
		<java.version>17</java.version>
		<kotlin.version>1.8.21</kotlin.version>
	</properties>
	<dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-web</artifactId>
		</dependency>
		<dependency>
			<groupId>com.fasterxml.jackson.module</groupId>
			<artifactId>jackson-module-kotlin</artifactId>
		</dependency>
		<dependency>
			<groupId>org.jetbrains.kotlin</groupId>
			<artifactId>kotlin-reflect</artifactId>
		</dependency>
		<dependency>
			<groupId>org.jetbrains.kotlin</groupId>
			<artifactId>kotlin-stdlib-jdk8</artifactId>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-test</artifactId>
			<scope>test</scope>
		</dependency>
        <dependency>
            <groupId>org.jetbrains.kotlin</groupId>
            <artifactId>kotlin-stdlib-jdk8</artifactId>
            <version>${kotlin.version}</version>
        </dependency>
        <dependency>
            <groupId>org.jetbrains.kotlin</groupId>
            <artifactId>kotlin-test</artifactId>
            <version>${kotlin.version}</version>
            <scope>test</scope>
        </dependency>
    </dependencies>

	<build>
		<sourceDirectory>src/main/kotlin</sourceDirectory>
		<testSourceDirectory>src/test/kotlin</testSourceDirectory>
		<plugins>
			<plugin>
				<groupId>org.springframework.boot</groupId>
				<artifactId>spring-boot-maven-plugin</artifactId>
				<executions>
					<execution>
						<goals>
							<!-- ç”Ÿæˆå¯æ‰§è¡Œ JAR åŒ… -->
							<goal>repackage</goal>
						</goals>
					</execution>
				</executions>
			</plugin>
			<plugin>
				<groupId>org.jetbrains.kotlin</groupId>
				<artifactId>kotlin-maven-plugin</artifactId>
                <version>${kotlin.version}</version>
                <executions>
                    <execution>
                        <id>compile</id>
                        <phase>compile</phase>
                        <goals>
                            <goal>compile</goal>
                        </goals>
                    </execution>
                    <execution>
                        <id>test-compile</id>
                        <phase>test-compile</phase>
                        <goals>
                            <goal>test-compile</goal>
                        </goals>
                    </execution>
                </executions>
                <configuration>
					<args>
						<arg>-Xjsr305=strict</arg>
					</args>
					<compilerPlugins>
						<plugin>spring</plugin>
					</compilerPlugins>
                    <jvmTarget>17</jvmTarget>
                </configuration>
				<dependencies>
					<dependency>
						<groupId>org.jetbrains.kotlin</groupId>
						<artifactId>kotlin-maven-allopen</artifactId>
						<version>${kotlin.version}</version>
					</dependency>
				</dependencies>
			</plugin>
		</plugins>
	</build>
</project>
```

æœ‰äº†è¿™ä¸ªxmlæ–‡ä»¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨mavenæ¥ç¼–è¯‘æˆ‘ä»¬çš„å·¥ç¨‹äº†ã€‚

ç¼–è¯‘ï¼š
```
mvn compile
```

ç”Ÿæˆå¯æ‰§è¡ŒjaråŒ…ï¼š
```
mvn package
```

ç„¶åè¿è¡Œï¼š
```
java -jar target/chat-0.0.1-SNAPSHOT.jar
```

ä¹Ÿå¯ä»¥ç›´æ¥åœ¨IDEé‡Œé¢è¿è¡Œã€‚

è¿è¡Œèµ·æ¥çš„æ•ˆæœæ˜¯åƒè¿™æ ·çš„ï¼š
```

  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::                (v3.0.6)

2023-05-13T01:32:16.879+08:00  INFO 5925 --- [           main] cn.lusing.chat.chat.ChatApplicationKt    : Starting ChatApplicationKt using Java 17.0.6 with PID 5925 (/Users/liuziying/working/misc/java/chat/chat/target/classes started by liuziying in /Users/liuziying/working/misc/java/chat)
2023-05-13T01:32:16.884+08:00  INFO 5925 --- [           main] cn.lusing.chat.chat.ChatApplicationKt    : No active profile set, falling back to 1 default profile: "default"
2023-05-13T01:32:17.868+08:00  INFO 5925 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 8080 (http)
2023-05-13T01:32:17.879+08:00  INFO 5925 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]
2023-05-13T01:32:17.880+08:00  INFO 5925 --- [           main] o.apache.catalina.core.StandardEngine    : Starting Servlet engine: [Apache Tomcat/10.1.8]
2023-05-13T01:32:17.984+08:00  INFO 5925 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext
2023-05-13T01:32:17.986+08:00  INFO 5925 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 1044 ms
2023-05-13T01:32:18.240+08:00  INFO 5925 --- [           main] o.s.b.a.w.s.WelcomePageHandlerMapping    : Adding welcome page: class path resource [static/index.html]
2023-05-13T01:32:18.373+08:00  INFO 5925 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8080 (http) with context path ''
2023-05-13T01:32:18.383+08:00  INFO 5925 --- [           main] cn.lusing.chat.chat.ChatApplicationKt    : Started ChatApplicationKt in 1.905 seconds (process running for 2.373)
```

### å†™ä¸€ä¸ªå¤„ç†Rest APIçš„ç±»

Restæ˜¯Resource Representational State Transferçš„ç¼©å†™ï¼Œç›´è¯‘ä¸ºè¡¨ç°å±‚çŠ¶æ€è½¬ç§»ï¼Œæ˜¯ä¸€ç§è½¯ä»¶æ¶æ„é£æ ¼ï¼Œç”¨äºè®¾è®¡å’Œå®ç°WebæœåŠ¡ã€‚

Restçš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†ç½‘ç»œä¸Šçš„èµ„æºç”¨ç»Ÿä¸€èµ„æºæ ‡è¯†ç¬¦ï¼ˆURIï¼‰æ¥è¡¨ç¤ºï¼Œå¹¶é€šè¿‡HTTPåè®®æä¾›çš„æ–¹æ³•ï¼ˆå¦‚GETã€POSTã€PUTã€DELETEç­‰ï¼‰æ¥å¯¹èµ„æºè¿›è¡Œæ“ä½œã€‚

Restçš„ä¼˜ç‚¹æ˜¯ç®€åŒ–äº†æ¥å£çš„è®¾è®¡ï¼Œæé«˜äº†å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œé€‚ç”¨äºå„ç§å®¢æˆ·ç«¯å’Œå¹³å°ã€‚

æˆ‘ä»¬çš„æœåŠ¡ç«¯ä»£ç å°±è¦åŸºäºRest APIæ¥æä¾›æœåŠ¡ã€‚

æˆ‘ä»¬å…ˆå†™ä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­è®©å¤§å®¶ç†è§£ä¸€ä¸‹Rest APIçš„å·¥ä½œæ–¹å¼ï¼š

```kotlin
package cn.lusing.chat.chat
import org.springframework.web.bind.annotation.*

@CrossOrigin(origins = ["*"])
@RestController
class MainController{
    @RequestMapping("/api/v1/chat/{message}")
    fun hello(@PathVariable(name="message") message : String) : String {
        return "Hello,Chat!$message";
    }

    @PostMapping("/api/v1/chat2")
    fun hello2(@RequestBody json: String) : String {
        return "{'data':'$json'}";
    }
}
```

æˆ‘ä»¬ä»¥ä¸€ä¸ªgetè¯·æ±‚å’Œä¸€ä¸ªpostè¯·æ±‚ä¸ºä¾‹ï¼Œç»™å¤§å®¶è®²è§£ä¸‹Rest APIæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹getè¯·æ±‚ï¼Œè¿™ä¸ªè¯·æ±‚çš„åœ°å€æ˜¯ï¼šhttp://localhost:8080/api/v1/chat/chatgptã€‚

![](https://xulun-games.oss-cn-beijing.aliyuncs.com/chat1.png?Expires=1683912667&OSSAccessKeyId=TMP.3KjoFQX73x2Xr8f2nk5RNnLZ3a3dzWemzPweHcLpJX55aQLAyXdNZLLhP6MxcGMUVUkTYHoSa8hgWCNYwtDQViYnWoCovh&Signature=RdFCYXoJJT2jUhT8b9asrC3KyDo%3D)

æˆ‘ä»¬é€šè¿‡æµè§ˆå™¨è®¿é—®è¿™ä¸ªåœ°å€ï¼Œå¯ä»¥çœ‹åˆ°è¿”å›çš„ç»“æœæ˜¯ï¼šHello,Chat!chatgptã€‚å…¶ä¸­ï¼Œchatgptå°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„å‚æ•°ï¼Œå¤§å®¶å¯ä»¥æ¢ä¸€ä¸ªè¯•è¯•æ•ˆæœã€‚

ä½†æ˜¯ï¼Œåœ¨URLé‡Œé¢ä¼ é€’å‚æ•°ï¼Œæœ‰æ—¶å€™æ˜¯ä¸æ–¹ä¾¿çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦ä¼ é€’ä¸€ä¸ªå¾ˆé•¿çš„æ–‡æœ¬ï¼Œè¿™ä¸ªæ–‡æœ¬å¯èƒ½ä¼šè¶…è¿‡URLçš„é•¿åº¦é™åˆ¶ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨postè¯·æ±‚ã€‚

Postè¯·æ±‚å°±æ— æ³•å°†å‚æ•°æ”¾åœ¨URLé‡Œé¢äº†ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå‚æ•°æ”¾åœ¨è¯·æ±‚çš„bodyé‡Œé¢ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨curlå‘½ä»¤æ¥æµ‹è¯•ä¸€ä¸‹ï¼š

```
curl -X POST http://127.0.0.1:8080/api/v1/chat2 -d '{message:"aaa"}'
```

è¿”å›å€¼å¦‚ä¸‹ï¼š
```
{'data':'%7Bmessage%3A%22aaa%22%7D='}%
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä¼ å…¥çš„å‚æ•°æ˜¯{message:"aaa"}ï¼Œä½†æ˜¯è¿”å›çš„ç»“æœæ˜¯%7Bmessage%3A%22aaa%22%7D=ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬ä¼ å…¥çš„å‚æ•°æ˜¯jsonæ ¼å¼çš„ï¼Œè€Œè¿”å›çš„ç»“æœæ˜¯urlç¼–ç çš„æ ¼å¼ã€‚

### å†™é¦–é¡µ

æˆ‘ä»¬çš„é¦–é¡µå°±æ˜¯ä¸€ä¸ªhtmlæ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æŠŠå®ƒæ”¾åœ¨resources/static/index.htmlé‡Œé¢ã€‚

```html
<!DOCTYPE html>
<html>
<head>
    <title>æ™ºèƒ½é—®ç­”ç³»ç»Ÿ Powered by chatgpt</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="p-6 bg-gray-200">
    <h1 class="text-3xl mb-4">Chat Interface</h1>
    <input type="text" id="message" placeholder="Type your message here" class="px-4 py-2 mb-4 w-full border-2 border-gray-300 rounded">
    <button id="send" class="px-4 py-2 bg-blue-500 text-white rounded">Send</button>
    <div id="response" class="mt-4 p-4 border-2 border-gray-300 rounded"></div>

    <script>
        document.querySelector("#send").addEventListener('click', async () => {
            const message = document.querySelector("#message").value;
            try {
                const response = await fetch('/api/v1/chat2', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message })
                });
                const data = await response.text();
                document.querySelector("#response").textContent = data;
            } catch (error) {
                console.error('Error:', error);
            }
        });
    </script>
</body>
</html>
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªé¡µé¢æœ‰ä¸€ä¸ªè¾“å…¥æ¡†ï¼Œä¸€ä¸ªæŒ‰é’®ï¼Œä¸€ä¸ªè¾“å‡ºæ¡†ã€‚æˆ‘ä»¬åœ¨è¾“å…¥æ¡†é‡Œé¢è¾“å…¥å†…å®¹ï¼Œç„¶åç‚¹å‡»æŒ‰é’®ï¼Œå°±å¯ä»¥æŠŠè¾“å…¥çš„å†…å®¹å‘é€åˆ°åç«¯ï¼Œç„¶ååç«¯è¿”å›ä¸€ä¸ªç»“æœï¼Œè¿™ä¸ªç»“æœå°±æ˜¾ç¤ºåœ¨è¾“å‡ºæ¡†é‡Œé¢ã€‚

è¿è¡Œçš„æ•ˆæœå¦‚ä¸‹ï¼š
![](https://xulun-mooc.oss-cn-beijing.aliyuncs.com/chat2.png)

### è°ƒç”¨openai API

ä¸‹é¢æˆ‘ä»¬å°±å‰©æœ€åä¸€é“å·¥åºäº†ï¼ŒæŠŠç”¨æˆ·çš„è¾“å…¥ä¼ ç»™openaiï¼Œç„¶åæŠŠopenaiçš„ç»“æœè¿”å›ç»™ç”¨æˆ·:

```kotlin
package cn.lusing.chat.chat

import java.io.OutputStreamWriter
import java.net.HttpURLConnection
import java.net.URL

fun chatWithOpenAI(apiKey: String, message: String): String {
    val url = URL("https://api.openai.com/v1/chat/completions")
    with(url.openConnection() as HttpURLConnection) {
        requestMethod = "POST" // è®¾ç½®è¯·æ±‚ç±»å‹ä¸º POST

        // è®¾ç½®è¯·æ±‚å¤´
        setRequestProperty("Content-Type", "application/json")
        setRequestProperty("Authorization", "Bearer $apiKey")

        // è®¾ç½®è¯·æ±‚ä½“
        val body = """
            {
                "model": "gpt-3.5-turbo",
                "messages": [
                    {
                        "role": "system",
                        "content": "You are a helpful assistant."
                    },
                    {
                        "role": "user",
                        "content": "$message"
                    }
                ]
            }
        """.trimIndent()

        doOutput = true
        OutputStreamWriter(outputStream).use {
            it.write(body)
        }

        // è¿”å›å“åº”
        return inputStream.bufferedReader().use { it.readText() }
    }
}
```

æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹Controllerçš„æ–¹æ³•ï¼š
```kotlin
    @PostMapping("/api/v1/chat2")
    fun hello2(@RequestBody json: String): String {
        val jsonNode = objectMapper.readTree(json)
        val message = jsonNode.get("message")?.asText()
        val apiKey = "ä½ çš„key"
        return chatWithOpenAI(apiKey, "$message");
    }
```

æˆ‘ä»¬æ¥çœ‹ä¸‹æ•ˆæœï¼š
![](https://xulun-mooc.oss-cn-beijing.aliyuncs.com/chatgpt1.png)

é“¾è·¯å·²ç»é€šäº†ã€‚

åé¢è°ƒè°ƒæ ¼å¼ï¼Œé¦–å…ˆæŠŠdataæ”¹æˆdata?.choices[0]?.message?.contentï¼š

```javascript
        document.querySelector("#send").addEventListener('click', async () => {
            const message = document.querySelector("#message").value;
            try {
                const response = await fetch('/api/v1/chat2', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message })
                });
                const data = await response.json();
                document.querySelector("#response").textContent = data?.choices[0]?.message?.content;
            } catch (error) {
                console.error('Error:', error);
            }
        });
```

å†ç»™response divæ”¹ä¸ªå¢åŠ ä¸ªpreçš„æ ·å¼ï¼š
```html
<div id="response" class="mt-4 p-4 border-2 border-gray-300 rounded" style="white-space: pre;"></div>
```

æ•ˆæœå¦‚ä¸‹ï¼š
![](https://xulun-mooc.oss-cn-beijing.aliyuncs.com/fortran.png)

ä»£ç æ ¼å¼æ²¡æœ‰highlightï¼Œæˆ‘ä»¬ä¹‹å‰åœ¨å‰ç«¯çš„æ—¶å€™æè¿‡äº†ï¼Œè¿™é‡Œå°±ä¸å†é‡å¤äº†ã€‚

## å°ç»“

æ­å–œï¼Œä»æ­¤æ‚¨è§£é”äº†è°ƒç”¨å¤§æ¨¡å‹çš„åç«¯èƒ½åŠ›ã€‚
